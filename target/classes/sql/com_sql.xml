<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<sqlRoot>
	<sqlGroup name="type">
	  	<!-- 运维-分配 根据运维人员id，获取处理故障类型列表 -->
  	<sql id="findOperatorTypeBySelect">
  		SELECT ct.id id, ct.name typename
  	</sql>
  	<sql id="findOperatorTypeByFrom">
  		FROM com_type AS ct 
		WHERE ct.deleted_at is null 
		AND ct.id in(
      		SELECT cut.type_id 
      		FROM com_user_type AS cut 
      		WHERE cut.user_id=?)
  	</sql>
  		<!-- 部门-分配 根据部门id，获取处理故障类型列表 -->
  	<sql id="findApartmentTypeBySelect">
  		select type.id id, type.name typename
  	</sql>
  	<sql id="findApartmentTypeByFrom">
  		from com_type as type
  		where type.deleted_at is null 
  		and type.id in(
  			select apartmenttype.type_id
  			from com_apartment_type as apartmenttype 
  			where apartmenttype.apartment_id=?
  		)
  		
  	</sql>
	</sqlGroup>
	
	<sqlGroup name="apartment">
	<!-- 根据故障类型，查找运维部门的信息 -->
	<sql id="findApartmentBySelect">
		select apartment.id,apartment.name, apartment.pid,
		apartment.created_at,apartment.updated_at,apartment.deleted_at
	</sql>
	<sql id="findApartmentByFrom">
		from com_apartment as apartment
		where apartment.id in(
			select apartmenttype.apartment_id
			from com_apartment_type as apartmenttype
			where apartmenttype.type_id=?
		)
	</sql>
	</sqlGroup>
	
	
  	<sqlGroup name="order">

  	<!-- 通用 -->
  	<!-- 根据工单id查询该工单的详细内容 多表查询 -->
  	<sql id="findOrderInfoBySelect">
		SELECT o.id oorderid,  t1.name tname,o.type otypeid,l1.name lname,o.level olevelid,
		o.offer_user oofferid,u1.full_name uoffername, u1.phone uofferphone,
		o.description odescription,o.offer_at ooffertime,o.status ostatus,
		o.deal_user odealid,  u2.full_name udealname,  u2.phone udealphone,
		o.accept_user oacceptid,accept.full_name uacceptname,accept.phone uacceptphone,
		o.accepted_at oacceptedtime,o.title otitle,
		o.comment ocomment,o.deal_at odealtime,o.accept_at oaccepttime,
		o.addcomment oaddcomment,o.add_at oaddtime,
		o.spend_time ospendtime,
		o.created_at ocreatetime,o.deleted_at odeletetime,o.flag oflag
  	</sql>

  	<sql id="findOrderInfoByFrom"><!-- 根据条件，查询工单 -->
  	  	FROM com_order AS o 
		LEFT OUTER JOIN sec_user AS u1 ON o.offer_user = u1.id
		LEFT OUTER JOIN sec_user AS u2 ON o.deal_user = u2.id
		LEFT OUTER JOIN sec_user AS accept ON o.accept_user=accept.id
		LEFT OUTER JOIN com_type AS t1 ON o.type=t1.id
		LEFT OUTER JOIN com_level AS l1 ON o.level=l1.id
  	</sql>
  	
  	<sql id="findOfferQueryBySelect"><!-- Reports-Operates-Orders 分页故障查询 -->
  	SELECT o.id, o.description, u1.bname off_branch,u1.full_name off_user,o.offer_at,  o.status,
  		 u2.full_name deal_user ,o.deal_at ,o.type tid, t1.name type_name,u2.bname deal_branch,
  		 o.created_at,o.updated_at,o.deleted_at,o.title,o.comment,o.addcomment
  	</sql>
  	
  	<sql id="findOfferQueryByFrom"><!-- Reports-Operates-Orders 分页故障查询 -->
  	FROM com_order AS o 
		LEFT OUTER JOIN 
		(
			select uu1.id id,uu1.full_name full_name, bb1.name bname
			from sec_user_info as ssui
						 left outer join sec_user as uu1 on ssui.user_id=uu1.id
						 left outer join com_branch as bb1 on ssui.branch_id=bb1.id
		) 
			AS u1 ON o.offer_user = u1.id
		LEFT OUTER JOIN 
    (
			select uu1.id id,uu1.full_name full_name, bb1.name bname
			from sec_user_info as ssui
						 left outer join sec_user as uu1 on ssui.user_id=uu1.id
						 left outer join com_branch as bb1 on ssui.branch_id=bb1.id
		) 
			AS u2 ON o.deal_user = u2.id
		LEFT OUTER JOIN com_type 
			AS t1 ON o.type=t1.id
  	</sql>
  	
  </sqlGroup>
  
  
  <sqlGroup name="comment">
  
  	<sql id="findCommentsBySelect">
  	SELECT comments.id, comments.context ,comments.add_at ,user1.uid,user1.ufull_name,user1.uphone,
	user1.bname,user1.apartmentid,user1.apartmentpid,user1.aname,user1.pname
  	</sql>
  	<sql id="findCommentsByFrom">
  	FROM com_comment AS comments
	LEFT OUTER JOIN (
		SELECT 
		user.id uid,user.full_name ufull_name,user.phone uphone,
		branch.name bname,apartment.id apartmentid,apartment.pid apartmentpid,
		apartment.name aname,position.name pname
		FROM sec_user_info AS userinfo
		LEFT OUTER JOIN  sec_user AS user ON userinfo.user_id=user.id
		LEFT OUTER JOIN  com_branch AS branch ON userinfo.branch_id=branch.id
		LEFT OUTER JOIN  com_apartment AS apartment ON userinfo.apartment_id=apartment.id
		LEFT OUTER JOIN  com_position AS position ON userinfo.position_id=position.id
	) 
	AS user1 ON comments.user_id=user1.uid
  	</sql>
  </sqlGroup>
  

</sqlRoot>